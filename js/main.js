const estacionesPorLinea = {
  urquiza: [
    { nombre: "Federico Lacroze", lat: -34.595681, lon: -58.535818 },
    { nombre: "José Artigas", lat: -34.595654, lon: -58.535701 },
    { nombre: "Pedro N. Arata", lat: -34.595683, lon: -58.535588 },
    { nombre: "Francisco Beiró", lat: -34.595719, lon: -58.535454 },
    { nombre: "El Libertador", lat: -34.595731, lon: -58.535303 },
    { nombre: "Antonio Devoto", lat: -34.595763, lon: -58.535134 },
    { nombre: "Coronel F. Lynch", lat: -34.59583, lon: -58.534863 },
    { nombre: "Fernández Moreno", lat: -34.59585, lon: -58.534689 },
    { nombre: "Lourdes", lat: -34.593692, lon: -58.547412 },
    { nombre: "Tropezón", lat: -34.593581, lon: -58.547445 },
    { nombre: "José María Bosch", lat: -34.593483, lon: -58.547485 },
    { nombre: "Martín Coronado", lat: -34.593432, lon: -58.547654 },
    { nombre: "Pablo Podestá", lat: -34.593486, lon: -58.54753 },
    { nombre: "Jorge Newbery", lat: -34.593578, lon: -58.547356 },
    { nombre: "Rubén Darío", lat: -34.593642, lon: -58.547236 },
    { nombre: "Ejército de los Andes", lat: -34.593729, lon: -58.547105 },
    { nombre: "Juan B. de La Salle", lat: -34.593828, lon: -58.547116 },
    { nombre: "Sargento Barrufaldi", lat: -34.593923, lon: -58.547144 },
    { nombre: "Capitán Lozano", lat: -34.593919, lon: -58.547352 },
    { nombre: "Teniente Agneta", lat: -34.593845, lon: -58.547601 },
    { nombre: "Campo de Mayo", lat: -34.593778, lon: -58.547791 },
    { nombre: "Sargento Cabral", lat: -34.593719, lon: -58.547972 },
    { nombre: "General Lemos", lat: -34.593668, lon: -58.548125 },
  ],
  sanmartin: [
    { nombre: "Retiro", lat: -34.5894, lon: -58.3732 },
    { nombre: "Palermo", lat: -34.5781, lon: -58.4246 },
    { nombre: "Villa Crespo", lat: -34.5875, lon: -58.4411 },
    { nombre: "La Paternal", lat: -34.5961, lon: -58.4683 },
    { nombre: "Villa del Parque", lat: -34.6065, lon: -58.4912 },
    { nombre: "Devoto", lat: -34.6102, lon: -58.5045 },
    { nombre: "Sáenz Peña", lat: -34.6108, lon: -58.5255 },
    { nombre: "Santos Lugares", lat: -34.6129, lon: -58.5424 },
    { nombre: "Caseros", lat: -34.6109, lon: -58.5631 },
    { nombre: "El Palomar", lat: -34.6086, lon: -58.5873 },
    { nombre: "Hurlingham", lat: -34.6022, lon: -58.6422 },
    { nombre: "William C. Morris", lat: -34.6025, lon: -58.6523 },
    { nombre: "Bella Vista", lat: -34.5983, lon: -58.6667 },
    { nombre: "Muñiz", lat: -34.5611, lon: -58.707 },
    { nombre: "San Miguel", lat: -34.5432, lon: -58.7111 },
    { nombre: "José C. Paz", lat: -34.5194, lon: -58.775 },
    { nombre: "Sol y Verde", lat: -34.5056, lon: -58.7931 },
    { nombre: "Derqui", lat: -34.4932, lon: -58.7987 },
    { nombre: "Villa Astolfi", lat: -34.4765, lon: -58.8089 },
    { nombre: "Pilar", lat: -34.4583, lon: -58.9125 },
    { nombre: "Manzanares", lat: -34.4292, lon: -58.95 },
    { nombre: "Dr. Cabred", lat: -34.41, lon: -58.98 },
  ],
  belgranoSur: [
    { nombre: "Dr. Sáenz", lat: -34.6381, lon: -58.4173 },
    { nombre: "Villa Soldati", lat: -34.658, lon: -58.443 },
    { nombre: "Presidente Illia", lat: -34.6595, lon: -58.456 },
    { nombre: "Villa Lugano", lat: -34.662, lon: -58.47 },
    { nombre: "Villa Madero", lat: -34.67, lon: -58.48 },
    { nombre: "Marinos del Fournier", lat: -34.675, lon: -58.49 },
    { nombre: "Tapiales", lat: -34.68, lon: -58.5 },
    { nombre: "Aldo Bonzi", lat: -34.685, lon: -58.51 },
    { nombre: "Sánchez de Mendeville", lat: -34.69, lon: -58.52 },
    { nombre: "José Ingenieros", lat: -34.695, lon: -58.53 },
    { nombre: "Justo Villegas", lat: -34.7, lon: -58.54 },
    { nombre: "Isidro Casanova", lat: -34.705, lon: -58.55 },
    { nombre: "Rafael Castillo", lat: -34.71, lon: -58.56 },
    { nombre: "Merlo Gómez", lat: -34.715, lon: -58.57 },
    { nombre: "Libertad", lat: -34.72, lon: -58.58 },
    { nombre: "Marinos C. G. Belgrano", lat: -34.725, lon: -58.59 },
  ],
  belgranoNorte: [
    { nombre: "Retiro (Belgrano Norte)", lat: -34.5913, lon: -58.3741 },
    { nombre: "Saldías", lat: -34.582, lon: -58.39 },
    { nombre: "Ciudad Universitaria", lat: -34.56, lon: -58.44 },
    { nombre: "Aristóbulo del Valle", lat: -34.55, lon: -58.45 },
    { nombre: "M. M. Padilla", lat: -34.54, lon: -58.46 },
    { nombre: "Florida", lat: -34.53, lon: -58.47 },
    { nombre: "Munro", lat: -34.52, lon: -58.48 },
    { nombre: "Carapachay", lat: -34.51, lon: -58.49 },
    { nombre: "Villa Adelina", lat: -34.5, lon: -58.5 },
    { nombre: "Boulogne Sur Mer", lat: -34.49, lon: -58.51 },
    { nombre: "Vicealmirante Montes", lat: -34.48, lon: -58.52 },
    { nombre: "Don Torcuato", lat: -34.47, lon: -58.53 },
    { nombre: "Ing. A. Sourdeaux", lat: -34.46, lon: -58.54 },
    { nombre: "Villa de Mayo", lat: -34.45, lon: -58.55 },
    { nombre: "Los Polvorines", lat: -34.44, lon: -58.56 },
    { nombre: "Ing. Pablo Nogués", lat: -34.43, lon: -58.57 },
    { nombre: "Grand Bourg", lat: -34.42, lon: -58.58 },
    { nombre: "Tierras Altas", lat: -34.41, lon: -58.59 },
    { nombre: "Tortuguitas", lat: -34.4, lon: -58.6 },
    { nombre: "Manuel Alberti", lat: -34.39, lon: -58.61 },
    { nombre: "Del Viso", lat: -34.38, lon: -58.62 },
    { nombre: "Cecilia Grierson", lat: -34.37, lon: -58.63 },
    { nombre: "Villa Rosa", lat: -34.36, lon: -58.64 },
  ],
};

const coordenadasPlanoUrquiza = {
  "Federico Lacroze":       { top: "50%", left: "0%" },
  "Artigas":                { top: "50%", left: "4%" },
  "Arata":                  { top: "50%", left: "8%" },
  "Beiró":                  { top: "50%", left: "12%" },
  "El Libertador":          { top: "50%", left: "16%" },
  "Devoto":                 { top: "50%", left: "20%" },
  "Lynch":                  { top: "50%", left: "24%" },
  "F. Moreno":              { top: "50%", left: "28%" },
  "Lourdes":                { top: "50%", left: "32%" },
  "Tropezón":               { top: "50%", left: "36%" },
  "J. M. Bosch":            { top: "50%", left: "40%" },
  "M. Coronado":            { top: "50%", left: "44%" },
  "P. Podestá":             { top: "50%", left: "48%" },
  "J. Newbery":             { top: "50%", left: "52%" },
  "Rubén Darío":            { top: "50%", left: "56%" },
  "Ej. de los Andes":       { top: "50%", left: "60%" },
  "J. B. de La Salle":      { top: "50%", left: "64%" },
  "Sgto. Barrufaldi":       { top: "50%", left: "68%" },
  "Cap. Lozano":            { top: "50%", left: "72%" },
  "Tte. Agneta":            { top: "50%", left: "76%" },
  "Campo de Mayo":          { top: "50%", left: "80%" },
  "Sgto. Cabral":           { top: "50%", left: "84%" },
  "General Lemos":          { top: "50%", left: "88%" }
};

const planosPorLinea = {
  urquiza: "imgs/planos/plano_urquiza_-_mt.png",
  belgranoSur: "imgs/planos/plano_belgrano_sur.png",
  belgranoNorte: "imgs/planos/plano_belgrano_norte.png",
  sanmartin: "imgs/planos/plano_san_martin.png"
};

const coordenadasPorLinea = {
  urquiza: coordenadasPlanoUrquiza//, TODO complete
  //belgranoSur: coordenadasPlanoBelgranoSur,
  //belgranoNorte: coordenadasPlanoBelgranoNorte,
  //sanmartin: coordenadasPlanoSanMartin
};

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function verEstacion() {
  const lineaSeleccionada = document.getElementById("linea").value;
  const resultadoDiv = document.getElementById("resultado");
  const planoContainer = document.getElementById("planoContainer");
  const planoImagen = document.getElementById("planoImagen");
  const marcador = document.getElementById("marcador");

  resultadoDiv.innerText = "";

  if (!lineaSeleccionada || !estacionesPorLinea[lineaSeleccionada]) {
    resultadoDiv.innerText = "Seleccioná una línea válida.";
    planoContainer.classList.add("hidden");
    return;
  }

  const estaciones = estacionesPorLinea[lineaSeleccionada];

  resultadoDiv.innerText = "Detectando ubicación...";

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      let estacionCercana = estaciones[0];
      let distanciaMinima = getDistance(lat, lon, estacionCercana.lat, estacionCercana.lon);

      estaciones.forEach(estacion => {
        const distancia = getDistance(lat, lon, estacion.lat, estacion.lon);
        if (distancia < distanciaMinima) {
          distanciaMinima = distancia;
          estacionCercana = estacion;
        }
      });

      resultadoDiv.innerHTML = `Estás cerca de <span class="text-indigo-600 font-bold">${estacionCercana.nombre}</span> (<span class="text-gray-600">${distanciaMinima.toFixed(2)} km</span>)`;

      // Mostrar plano si existe
      const planoSrc = planosPorLinea[lineaSeleccionada];
      const coordenadas = coordenadasPorLinea[lineaSeleccionada];

      if (planoSrc && coordenadas) {
        planoImagen.src = planoSrc;
        planoContainer.classList.remove("hidden");

        const coords = coordenadas[estacionCercana.nombre];
        if (coords) {
          marcador.style.top = coords.top;
          marcador.style.left = coords.left;
          marcador.classList.remove("hidden");
        } else {
          marcador.classList.add("hidden");
        }
      } else {
        planoContainer.classList.add("hidden");
      }

    }, () => {
      resultadoDiv.textContent = "No se pudo obtener tu ubicación.";
      planoContainer.classList.add("hidden");
    });
  } else {
    resultadoDiv.textContent = "Tu navegador no soporta geolocalización.";
    planoContainer.classList.add("hidden");
  }
}

function mostrarEnPlano(estacionNombre) {
  const marcador = document.getElementById("marcador");
  const coords = coordenadasPlanoUrquiza[estacionNombre];
  if (coords) {
    marcador.style.top = coords.top;
    marcador.style.left = coords.left;
    marcador.style.display = "block";
  } else {
    marcador.style.display = "none";
  }
}